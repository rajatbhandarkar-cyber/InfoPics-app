<% layout('/layouts/boilerplate') %>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>My Posts</h3>
  </div>

  <!-- üîò Toggle buttons -->
  <div class="d-flex justify-content-center mb-4">
    <button id="show-public" class="btn btn-dark mx-2">Public</button>
    <button id="show-private" class="btn btn-dark mx-2">Private</button>
  </div>

  <!-- Public posts section -->
  <div id="public-posts">
    <% if (!publicPosts || publicPosts.length === 0) { %>
      <div class="no-posts text-center w-100 my-5">
        <h4>No public posts found.</h4>
        <p class="text-muted">Start by clicking <a href="/posts/new">Share Experience</a>.</p>
      </div>
    <% } else { %>
      <div class="grid">
        <% for (let post of publicPosts) { %>
          <!-- Post card markup unchanged -->
        <% } %>
      </div>
    <% } %>
  </div>

  <!-- Private posts section -->
  <div id="private-posts" style="display:none;">
    <% if (!privatePosts || privatePosts.length === 0) { %>
      <div class="no-posts text-center w-100 my-5">
        <h4>No private posts found.</h4>
        <p class="text-muted">You can create private posts by selecting ‚ÄúPrivate‚Äù when adding a new post.</p>
      </div>
    <% } else { %>
      <div class="grid">
        <% for (let post of privatePosts) { %>
          <!-- Post card markup unchanged -->
        <% } %>
      </div>
    <% } %>
  </div>
</div>

<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script>
  // ‚úÖ Store Masonry instances instead of using Masonry.data()
  const masonryInstances = [];

  document.querySelectorAll('.grid').forEach(grid => {
    imagesLoaded(grid, function() {
      const msnry = new Masonry(grid, {
        itemSelector: '.grid-item',
        columnWidth: 340,
        gutter: 16,
        fitWidth: true
      });
      masonryInstances.push(msnry);
    });
  });

  document.addEventListener("click", function(e){
    if(e.target.classList.contains("read-more")){
      const card = e.target.closest(".card-body");
      const shortText = card.querySelector(".short-text");
      const fullText = card.querySelector(".full-text");

      if(fullText.style.display === "none"){
        shortText.style.display = "none";
        fullText.style.display = "inline";
        e.target.textContent = "Show less";
      } else {
        shortText.style.display = "inline";
        fullText.style.display = "none";
        e.target.textContent = "Read more";
      }

      // ‚úÖ Re-layout all Masonry grids safely
      masonryInstances.forEach(msnry => msnry.layout());
    }
  });

  // üîò Toggle logic with Masonry re-layout
  document.getElementById("show-public").onclick = () => {
    document.getElementById("public-posts").style.display = "block";
    document.getElementById("private-posts").style.display = "none";
    masonryInstances.forEach(msnry => msnry.layout());
  };

  document.getElementById("show-private").onclick = () => {
    document.getElementById("public-posts").style.display = "none";
    document.getElementById("private-posts").style.display = "block";
    masonryInstances.forEach(msnry => msnry.layout());
  };

  // Like & comment logic unchanged
  document.addEventListener("click", async function(e) {
    if (e.target.closest(".like-btn")) {
      const btn = e.target.closest(".like-btn");
      const postId = btn.dataset.id;
      const res = await fetch(`/posts/${postId}/like`, { method: "POST" });
      const data = await res.json();

      if (data.success) {
        btn.querySelector("i").classList.toggle("liked");
        const badge = btn.querySelector(".badge");
        if (badge) {
          badge.textContent = parseInt(badge.textContent) + (btn.querySelector("i").classList.contains("liked") ? 1 : -1);
        } else {
          btn.insertAdjacentHTML("beforeend", `<span class="badge bg-danger">1</span>`);
        }
      }
    }

    if (e.target.closest(".comment-btn")) {
      const btn = e.target.closest(".comment-btn");
      const postId = btn.dataset.id;
      window.location.href = `/posts/${postId}#all-comments`;
    }
  });
</script>

<style>
  .no-posts { padding: 3rem 1rem; }
</style>
