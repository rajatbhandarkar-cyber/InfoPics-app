<% layout("/layouts/boilerplate") %>

<div class="container mt-4">

  <!-- Post Header -->
  <div class="row mb-3">
    <div class="col-md-8 offset-md-2">
      <h3>Post Details</h3>
    </div>
  </div>

  <!-- Post Card -->
  <div class="row mb-3">
    <div class="col-md-8 offset-md-2">
      <div class="card listing-card">
        <img src="<%= post.image.url %>" class="card-img-top" alt="post_image">
        <div class="card-body">
          <p class="card-text"><%= post.description %></p>
          <p class="card-text">Owned by <i><%= post.owner.username %></i></p>
          <p class="card-text">
            <b><%= post.location %></b><br />
            <%= post.country %>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <div class="d-flex gap-2">
        <% if(currUser && post.owner._id.equals(currUser._id)) { %>
          <a href="/posts/<%= post._id %>/edit" class="btn btn-dark">Edit</a>
          <form method="POST" action="/posts/<%= post._id %>?_method=DELETE">
            <button class="btn btn-danger">Delete</button>
          </form>
        <% } %>
        <a href="/posts" class="btn btn-secondary">Back</a>
      </div>
    </div>
  </div>

  <!-- Share Section -->
  <div class="row mb-4">
  <div class="col-md-8 offset-md-2">
    <hr />
    <h5>Share the post:</h5>
    <div class="d-flex flex-wrap gap-3 mt-3">
      <a class="social-icon" target="_blank"
        href="https://www.facebook.com/sharer/sharer.php?u=https://infopics.in/posts/<%= post._id %>">
        <i class="fab fa-facebook-f"></i>
      </a>
      <a class="social-icon" target="_blank"
        href="https://twitter.com/intent/tweet?url=https://infopics.in/posts/<%= post._id %>&text=<%= encodeURIComponent(post.title) %>">
        <i class="fab fa-twitter"></i>
      </a>
      <a class="social-icon" target="_blank"
        href="https://wa.me/?text=https://infopics.in/posts/<%= post._id %>">
        <i class="fab fa-whatsapp"></i>
      </a>
      <a class="social-icon" target="_blank"
        href="https://www.instagram.com/"
        onclick="alert('Instagram doesnâ€™t support direct link sharing. Copy the link and paste it in your story or bio.')">
        <i class="fab fa-instagram"></i>
      </a>
      <a class="social-icon" target="_blank"
        href="https://www.linkedin.com/sharing/share-offsite/?url=https://infopics.in/posts/<%= post._id %>">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </div>
  </div>
  </div>

  <!-- Comment Section -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <hr />
      <% if(currUser) { %>
        <h4>Leave a Comment</h4>
        <form id="comment-form-page" action="/posts/<%= post._id %>/comments" method="POST" class="mb-4">
          <div class="mb-3">
            <textarea 
               id="page-comment-text"
               name="text" 
               class="form-control" 
               rows="4" 
               placeholder="Write your thoughts..." 
               required
            ></textarea>
          </div>
          <button class="btn btn-dark">Post Comment</button>
        </form>
      <% } %>

      <!-- Flash message -->
      <%- include("../includes/flash") %>

      <h5 id="all-comments"><b>All Comments</b></h5>
      <ul class="list-unstyled">
        <% for(let comment of [...post.comments].reverse()) { %>
          <li class="comment-item mb-3">
            <div class="comment-bubble">
              <div class="comment-author d-flex justify-content-between align-items-center">
                <span>@<%= comment.author?.username || "Anonymous" %></span>
                <% if (currUser && comment.author && comment.author._id.equals(currUser._id)) { %>
                  <form method="POST" action="/posts/<%= post._id %>/comments/<%= comment._id %>?_method=DELETE" class="d-inline">
                    <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent" title="Delete comment">
                      <i class="fas fa-trash text-danger"></i>
                    </button>
                  </form>
                <% } %>
              </div>
              <div class="comment-text"><%= comment.text %></div>
            </div>
          </li>
        <% } %>
      </ul>
    </div>
  </div>

</div>

<!-- Scroll and focus script -->
<script>
  window.addEventListener("load", () => {
    if (window.location.hash === "#comment-form-page") {
      const target = document.querySelector("#comment-form-page");
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
        const textarea = document.getElementById("page-comment-text");
        if (textarea) textarea.focus();
      }
    }
  });
</script>

<!-- Share Modal -->
<div class="modal fade" id="custom-share-modal" tabindex="-1" data-bs-backdrop="true" data-bs-keyboard="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share this post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <button class="btn btn-outline-dark mb-2" id="copy-link-btn">Copy Link</button>
        <div class="d-flex justify-content-center gap-3">
          <a id="facebook-share" target="_blank"><i class="fab fa-facebook fa-lg"></i></a>
          <a id="whatsapp-share" target="_blank" title="Share on WhatsApp"><i class="fab fa-whatsapp fa-lg"></i></a>
          <a id="instagram-share" target="_blank" title="Open Instagram"><i class="fab fa-instagram fa-lg"></i></a>
          <a id="twitter-share" target="_blank"><i class="fab fa-twitter fa-lg"></i></a>
          <a id="linkedin-share" target="_blank"><i class="fab fa-linkedin fa-lg"></i></a>
        </div>
      </div>
    </div>
  </div>
</div>
