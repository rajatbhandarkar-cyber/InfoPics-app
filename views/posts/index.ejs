<% layout('/layouts/boilerplate') %>

<div class="grid">
  <% if (allPosts.length === 0) { %>
    <div class="no-posts text-center w-100 my-5">
      <h4>No posts found for this location.</h4>
      <p class="text-muted">Try searching with a different keyword.</p>
    </div>
  <% } else { %>
    <% for (let post of allPosts) { %>
      <div class="grid-item post-card">
        <a href="/posts/<%= post._id %>" class="card-link">
          <img src="<%= post.image.url %>" class="card-img-top" alt="post_image">
        </a>

        <div class="card-body">
          <div class="post-content">
            <p>
              <b><%= post.location %></b><br />
                <% if (post.description.length > 500) { %>
                 <span class="short-text"><%= post.description.substring(0, 500) %>...</span>
                 <span class="full-text" style="display:none;"><%= post.description %></span>
                 <span class="read-more">Read more</span>
                <% } else { %>
                   <%= post.description %>
              <% } %>
            </p>
          </div>

          <!-- Wrap share-container in a right-aligned flex box -->
          <div style="width: 100%; display: flex; justify-content: flex-end;">
           <% if (currUser) { %>
            <div class="share-container d-flex align-items-center mt-3">
              <!-- Like Icon -->
              <!-- <div class="like-btn" title="Like this post">
                 <i class="fas fa-heart"></i>
              </div> -->
              <div class="like-btn" data-id="<%= post._id %>" data-liked="<%= post.likedBy.includes(currUser._id) %>">
                 <i class="fas fa-heart <%= post.likedBy.includes(currUser?._id) ? 'liked' : '' %>"></i>
                 <% if (post.likes && post.likes > 0) { %>
                   <span class="badge bg-danger"><%= post.likes %></span>
                 <% } %>
              </div>

              <!-- comment-icon -->
              <div class="comment-btn position-relative" data-id="<%= post._id %>" title="View and add comments">
                 <i class="fas fa-comment" style="font-size: 1.2rem; color: #000;"></i>
                    <% if (post.comments && post.comments.length > 0) { %>
                    <span class="badge">
                        <%= post.comments.length %>
                    </span>
                    <% } %>
              </div>

              <!-- Share Icon -->
              <div class="share-btn" data-url="https://infopics.in/posts/<%= post._id %>" data-title="Check out <%= post.location %> on InfoPics" title="Share this post">
                  <i class="fas fa-share-alt"></i>
              </div>
            </div>
           <% } %>
          </div>
        </div>
      </div>
    <% } %>
  <% } %>
</div>

<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script>
  // Masonry init
  var grid = document.querySelector('.grid');
  var msnry;
  if (grid) {
    imagesLoaded(grid, function() {
      msnry = new Masonry(grid, {
        itemSelector: '.grid-item',
        columnWidth: 340,
        gutter: 16,
        fitWidth: true
      });
    });
  }

  // Read more toggle
  document.addEventListener("click", function(e){
    if(e.target.classList.contains("read-more")){
      const card = e.target.closest(".card-body");
      const shortText = card.querySelector(".short-text");
      const fullText = card.querySelector(".full-text");

      if(fullText.style.display === "none"){
        shortText.style.display = "none";
        fullText.style.display = "inline";
        e.target.textContent = "Show less";
      } else {
        shortText.style.display = "inline";
        fullText.style.display = "none";
        e.target.textContent = "Read more";
      }

      if (msnry) msnry.layout();
    }
  });
</script>

<style>
  .no-posts {
    padding: 3rem 1rem;
  }
</style>

<!-- Comment Modal -->
<div class="modal fade" id="comment-modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Comments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Styled Comment List -->
        <ul id="comment-list" class="mb-3"></ul>

        <!-- Comment Form -->
        <form id="comment-form">
          <input type="hidden" id="comment-post-id">
          <textarea class="form-control mb-2" id="modal-comment-text" placeholder="Add your comment..." required></textarea>
          <button type="submit" class="comment-submit-btn mt-3">Post Comment</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Custom Share Modal -->
<div class="modal fade" id="custom-share-modal" tabindex="-1" data-bs-backdrop="true" data-bs-keyboard="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share this post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <button class="btn btn-outline-dark mb-2" id="copy-link-btn">Copy Link</button>
        <div class="d-flex justify-content-center gap-3">
           <a id="facebook-share" target="_blank"><i class="fab fa-facebook fa-lg"></i></a>
          <a id="whatsapp-share" target="_blank" title="Share on WhatsApp"><i class="fab fa-whatsapp fa-lg"></i></a>
          <a id="twitter-share" target="_blank"><i class="fab fa-twitter fa-lg"></i></a>
          <a id="linkedin-share" target="_blank"><i class="fab fa-linkedin fa-lg"></i></a>
        </div>
      </div>
    </div>
  </div>
</div>
