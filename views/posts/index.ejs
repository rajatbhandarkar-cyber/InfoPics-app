<% layout('/layouts/boilerplate') %>

<div class="grid">
  <% if (allPosts.length === 0) { %>
    <div class="no-posts text-center w-100 my-5">
      <h4>No posts found for this location.</h4>
      <p class="text-muted">Try searching with a different keyword.</p>
    </div>
  <% } else { %>
    <% for (let post of allPosts) { %>
      <div class="grid-item post-card">
        <a href="/posts/<%= post._id %>" class="card-link">
          <img src="<%= post.image.url %>" class="card-img-top" alt="post_image">
        </a>

        <div class="card-body">
          <div class="post-content">
            <p>
              <b><%= post.location %></b><br />
                <% if (post.description.length > 500) { %>
                 <span class="short-text"><%= post.description.substring(0, 500) %>...</span>
                 <span class="full-text" style="display:none;"><%= post.description %></span>
                 <span class="read-more">Read more</span>
                <% } else { %>
                   <%= post.description %>
              <% } %>
            </p>
          </div>

          <!-- Wrap share-container in a right-aligned flex box -->
          <div style="width: 100%; display: flex; justify-content: flex-end;">
            <div class="share-container d-flex align-items-center mt-3">
              <!-- Like Icon -->
              <div class="like-btn" title="Like this post">
                 <i class="fas fa-heart"></i>
              </div>

              <!-- Comment Icon with Badge -->
              <div class="comment-btn position-relative" title="View and add comments">
                 <a href="/posts/<%= post._id %>/comments">
                    <i class="fas fa-comment"></i>
                 </a>
                 <% if (post.comments && post.comments.length > 0) { %>
                   <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                      <%= post.comments.length %>
                   </span>
                 <% } %>
              </div>

              <!-- Share Icon -->
              <div class="share-btn" data-url="https://infopics.in/posts/<%= post._id %>" data-title="Check out <%= post.location %> on InfoPics" title="Share this post">
                  <i class="fas fa-share-alt"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  <% } %>
</div>

<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script>
  // Masonry init
  var grid = document.querySelector('.grid');
  var msnry;
  if (grid) {
    imagesLoaded(grid, function() {
      msnry = new Masonry(grid, {
        itemSelector: '.grid-item',
        columnWidth: 340,
        gutter: 16,
        fitWidth: true
      });
    });
  }

  // Read more toggle
  document.addEventListener("click", function(e){
    if(e.target.classList.contains("read-more")){
      const card = e.target.closest(".card-body");
      const shortText = card.querySelector(".short-text");
      const fullText = card.querySelector(".full-text");

      if(fullText.style.display === "none"){
        shortText.style.display = "none";
        fullText.style.display = "inline";
        e.target.textContent = "Show less";
      } else {
        shortText.style.display = "inline";
        fullText.style.display = "none";
        e.target.textContent = "Read more";
      }

      if (msnry) msnry.layout();
    }
  });
</script>

<style>
  .no-posts {
    padding: 3rem 1rem;
  }
</style>
