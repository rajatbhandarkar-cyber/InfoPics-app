<% layout("/layouts/boilerplate") %>

<main class="flex-grow-1 d-flex align-items-center justify-content-center">
  <div class="row w-100" style="max-width: 500px;">
    <h1 class="text-center mb-4">Verify Your Email</h1>

    <% if (locals.error && error.length > 0) { %>
      <div class="alert alert-danger text-center"><%= error %></div>
    <% } %>

    <% if (locals.success && success.length > 0) { %>
      <div class="alert alert-success text-center"><%= success %></div>
    <% } %>

    <p class="text-center mb-3">
      A 6-digit verification code was sent to
      <strong><%= typeof email !== "undefined" ? email : (tempUser && tempUser.email) || "your email" %></strong>.
      Enter it below to complete signup.
    </p>

    <form action="/verify/check" method="POST" class="needs-validation" autocomplete="off">
      <!-- Hidden pendingId allows cross-device verification when a PendingUser exists -->
      <input type="hidden" name="pendingId" value="<%= typeof pendingId !== 'undefined' ? pendingId : (session && session.pendingId) || '' %>" />

      <div class="mb-3">
        <label for="code" class="form-label">Enter the 6-digit code sent to your Gmail</label>
        <input
          name="code"
          id="code"
          type="text"
          class="form-control text-center"
          required
          maxlength="6"
          minlength="6"
          pattern="\d{6}"
        />
      </div>

      <button type="submit" class="btn btn-success w-100">Verify & Sign In</button>
    </form>

    <div class="text-center mt-3">
      <form action="/verify/send" method="POST">
        <!-- keep the pendingId in resend requests too -->
        <input type="hidden" name="pendingId" value="<%= typeof pendingId !== 'undefined' ? pendingId : (session && session.pendingId) || '' %>" />
        <button type="submit" class="btn btn-link">Resend Code</button>
      </form>
    </div>

    <% /* If this is a Google-origin pending/tempUser, surface a clear path to finish account creation */ %>
    <% if ((typeof pending !== 'undefined' && pending && pending.source === 'google') || (tempUser && tempUser.source === 'google')) { %>
      <div class="text-center mt-4">
        <p class="mb-2">You signed in with Google. Pick a username to finish creating your account.</p>
        <a href="/create-account" class="btn btn-primary w-100">Finish account (choose username)</a>
      </div>
    <% } %>

    <div class="text-center mt-2 text-muted small">
      If you opened this email on a different device, paste the code here. If you used Google Sign-in, your Google profile picture will be preserved when the account is created.
    </div>
  </div>
</main>
